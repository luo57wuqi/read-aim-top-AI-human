<!-- START OF FILE text/html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æç®€æ™ºè¯» v2.5 - æ™ºäº«ç»Ÿè®¡ç‰ˆ</title>
    <!-- å¼•å…¥ Tailwind CSS ç”¨äºå¿«é€Ÿå¸ƒå±€ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Remix Icon å›¾æ ‡åº“ -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- å¼•å…¥ Marked ç”¨äº Markdown è§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- 1. CSS å˜é‡å®šä¹‰ (é…è‰²æ–¹æ¡ˆ) --- */
        :root {
            /* åŸºç¡€å˜é‡ï¼Œå…·ä½“å€¼ç”± data-theme å±æ€§å†³å®š */
            --bg-color: #FAF7F2; 
            --text-color: #38302B; 
            --container-bg: #FAF7F2;
            --accent-color: #8C6A5D;
            --highlight-bg: rgba(255, 219, 88, 0.3);
            --ui-bg: rgba(250, 247, 242, 0.98);
            --border-color: rgba(60, 40, 30, 0.08);
            --sidebar-hover: rgba(0,0,0,0.03);
            --card-bg: #ffffff;
            --font-size: 18px;
            --line-height: 1.8;
            --reader-width: 800px;
        }

        /* ä¸»é¢˜ï¼šç¾Šçš®çº¸ (é»˜è®¤) */
        [data-theme="paper"] {
            --bg-color: #FAF7F2; --text-color: #38302B; --container-bg: #FAF7F2;
            --accent-color: #8C6A5D; --ui-bg: rgba(250, 247, 242, 0.98);
            --border-color: rgba(60, 40, 30, 0.1); --card-bg: #FFFFFF;
        }
        /* ä¸»é¢˜ï¼šé¢å£ (ç°/Zen) */
        [data-theme="wall"] {
            --bg-color: #E3E3E3; --text-color: #2F3542; --container-bg: #E3E3E3;
            --accent-color: #57606F; --ui-bg: rgba(227, 227, 227, 0.98);
            --border-color: rgba(0,0,0,0.1); --card-bg: #F1F2F6;
        }
        /* ä¸»é¢˜ï¼šé¦™èŠ‹ (æµ…ç´«) */
        [data-theme="lilac"] {
            --bg-color: #F8F0FC; --text-color: #4A235A; --container-bg: #F8F0FC;
            --accent-color: #8E44AD; --ui-bg: rgba(248, 240, 252, 0.98); --highlight-bg: rgba(142, 68, 173, 0.15);
            --border-color: rgba(142, 68, 173, 0.1); --card-bg: #FFFFFF;
        }
        /* ä¸»é¢˜ï¼šæŠ¤çœ¼ (ç»¿) */
        [data-theme="green"] { 
            --bg-color: #C7EDCC; --text-color: #2F3E2F; --container-bg: #C7EDCC; 
            --accent-color: #388E3C; --ui-bg: rgba(199, 237, 204, 0.98); 
            --border-color: rgba(0,0,0,0.08); --card-bg: #E8F5E9; 
        }
        /* ä¸»é¢˜ï¼šçº¯ç™½ */
        [data-theme="white"] { 
            --bg-color: #FFFFFF; --text-color: #111827; --container-bg: #FFFFFF; 
            --accent-color: #2563EB; --highlight-bg: rgba(37, 99, 235, 0.1); 
            --ui-bg: rgba(255, 255, 255, 0.98); --border-color: #E5E7EB; --card-bg: #F9FAFB; 
        }
        /* ä¸»é¢˜ï¼šæš—é»‘ */
        [data-theme="dark"] {
            --bg-color: #1A1A1A; --text-color: #B0B0B0; --container-bg: #1A1A1A;
            --accent-color: #718096; --highlight-bg: rgba(255, 255, 255, 0.1);
            --ui-bg: rgba(26, 26, 26, 0.98); --border-color: rgba(255,255,255,0.15);
            --sidebar-hover: rgba(255,255,255,0.05); --card-bg: #2D2D2D;
        }

        /* --- 2. é€šç”¨å¸ƒå±€æ ·å¼ --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", serif;
            transition: background-color 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
        }

        /* æ²‰æµ¸å¼ UI åŠ¨ç”» */
        .immersive-ui { transition: transform 0.3s ease, opacity 0.3s ease; }
        .ui-hidden .top-bar { transform: translateY(-100%); }
        .ui-hidden .bottom-bar { transform: translateY(100%); }
        
        /* é˜…è¯»å®¹å™¨ */
        .reader-container {
            background-color: var(--container-bg);
            min-height: 100vh;
            max-width: var(--reader-width);
            margin: 0 auto;
            padding: 80px 25px;
            font-size: var(--font-size);
            line-height: var(--line-height);
            transition: padding 0.3s;
        }
        
        /* Markdown å†…å®¹æ ·å¼ */
        .markdown-body h1 { font-size: 1.8em; margin-bottom: 1.5em; text-align: center; color: var(--text-color); }
        .markdown-body h2 { font-size: 1.4em; margin: 1.5em 0 0.8em; border-bottom: 1px solid var(--border-color); color: var(--text-color); }
        .markdown-body h3 { font-size: 1.2em; margin: 1.2em 0 0.6em; font-weight: bold; color: var(--text-color); }
        .markdown-body p { margin-bottom: 1em; text-align: justify; }
        .markdown-body blockquote { border-left: 4px solid var(--accent-color); padding-left: 1em; color: var(--accent-color); opacity: 0.85; margin: 1em 0; }
        .markdown-body code { background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px; font-size: 0.9em; }

        /* é«˜äº®åˆ’çº¿æ ·å¼ */
        .highlight-text {
            background: var(--highlight-bg);
            border-bottom: 1px dashed var(--accent-color);
            cursor: pointer;
            transition: background 0.2s;
        }
        .highlight-text:hover { background: rgba(0,0,0,0.1); }

        /* --- 3. äº¤äº’ç»„ä»¶æ ·å¼ --- */
        
        /* æ°”æ³¡èœå• */
        #bubble-menu {
            position: absolute; background: #333; border-radius: 8px; padding: 6px;
            display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            gap: 6px; transform: translateX(-50%); 
        }
        #bubble-menu button { color: white; padding: 4px 10px; font-size: 13px; border-radius: 4px; }
        #bubble-menu button:hover { background: #555; }

        /* ç¬”è®°å¼¹å‡ºæ¡† Popover */
        #note-popup {
            position: absolute; background: var(--ui-bg); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 12px; width: 260px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); z-index: 1100;
            display: none; font-size: 14px; color: var(--text-color); backdrop-filter: blur(10px);
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            position: fixed; top: 0; height: 100%; width: 340px;
            background: var(--ui-bg); z-index: 2000;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-color: var(--border-color); color: var(--text-color);
            box-shadow: 0 0 40px rgba(0,0,0,0.1); display: flex; flex-direction: column;
            backdrop-filter: blur(10px);
        }
        .sidebar-left { left: -360px; border-right-width: 1px; }
        .sidebar-left.active { left: 0; }
        .sidebar-right { right: -360px; border-left-width: 1px; }
        .sidebar-right.active { right: 0; }

        .toc-item { 
            padding: 12px 16px; border-radius: 8px; cursor: pointer; transition: background 0.2s; 
            margin-bottom: 6px; border: 1px solid transparent;
        }
        .toc-item:hover { background: var(--sidebar-hover); border-color: var(--border-color); }
        .toc-item.active { background: var(--sidebar-hover); color: var(--accent-color); font-weight: bold; border-color: var(--accent-color); }
        
        .toc-summary-box {
            font-size: 12px; background: rgba(0,0,0,0.03); padding: 8px; 
            border-radius: 6px; margin-top: 6px; font-weight: normal; color: var(--text-color);
            opacity: 0.8; line-height: 1.5; display: flex; flex-direction: column; gap: 6px;
        }
        .toc-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 4px; }
        .toc-btn { font-size: 10px; padding: 2px 8px; border-radius: 4px; border: 1px solid var(--border-color); opacity: 0.7; transition:all 0.2s; display: flex; align-items: center; gap: 4px; }
        .toc-btn:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); opacity: 1; }

        /* å…¨ä¹¦ç¬”è®°ç¼–è¾‘åŒº */
        #global-notes-editor {
            width: 100%; height: 75vh; background: transparent; border: none; outline: none;
            font-size: var(--font-size); line-height: var(--line-height); color: var(--text-color); resize: none;
        }

        /* --- 4. çœ‹æ¿ & å›¾è¡¨æ ·å¼ --- */
        .stat-card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 15px; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); display: flex; flex-direction: column; justify-content: center;
        }
        .stat-value { font-size: 24px; font-weight: bold; color: var(--accent-color); }
        .stat-label { font-size: 12px; opacity: 0.6; margin-top: 4px; }
        
        .dash-tab-btn { padding: 8px 16px; opacity: 0.5; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .dash-tab-btn.active { opacity: 1; border-bottom-color: var(--accent-color); font-weight: bold; color: var(--accent-color); }

        .chapter-row { display: grid; grid-template-columns: 50px 1fr 60px 80px; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); font-size: 13px; }
        .chapter-row:last-child { border-bottom: none; }
        .chapter-row:hover { background: var(--sidebar-hover); }

        /* å›¾è¡¨æ ·å¼ */
        .chart-bar-container { display: flex; align-items: flex-end; justify-content: space-between; height: 120px; gap: 8px; padding-top: 20px; }
        .chart-bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .chart-bar { width: 100%; background: var(--accent-color); opacity: 0.7; border-radius: 4px 4px 0 0; transition: height 0.5s ease; min-height: 2px; }
        .chart-bar:hover { opacity: 1; }
        .chart-label { font-size: 10px; opacity: 0.5; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }

        /* æ—¶é—´è½´ */
        .timeline-container { position: relative; padding-left: 20px; border-left: 2px solid var(--border-color); margin-left: 10px; margin-top: 10px; }
        .timeline-item { position: relative; margin-bottom: 20px; }
        .timeline-dot {
            position: absolute; left: -27px; top: 4px; width: 12px; height: 12px;
            background: var(--accent-color); border-radius: 50%; border: 2px solid var(--ui-bg); z-index: 10;
        }
        .timeline-content { background: var(--sidebar-hover); padding: 10px 14px; border-radius: 8px; font-size: 13px; }
        .timeline-time { font-family: monospace; opacity: 0.5; font-size: 11px; margin-bottom: 2px; }

        /* è®¾ç½®é¢æ¿ */
        #style-panel {
            position: absolute; top: 55px; right: 60px;
            background: var(--ui-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 15px; width: 300px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: none; flex-direction: column; gap: 12px; z-index: 2100;
        }
        .style-row { display: flex; align-items: center; justify-content: space-between; font-size: 13px; }
        .color-btn { width: 24px; height: 24px; border: 1px solid rgba(0,0,0,0.1); border-radius: 50%; cursor: pointer; position: relative; transition: transform 0.2s; }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.active::after { content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px; border: 2px solid var(--accent-color); border-radius: 50%; }

        /* æ‚¬æµ®çƒ & AI */
        #float-ball {
            position: fixed; right: 20px; bottom: 100px; width: 48px; height: 48px;
            background: var(--accent-color); color: white; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1500; cursor: pointer;
            transition: transform 0.1s;
        }
        #float-ball:active { transform: scale(0.95); }
        
        #ai-card {
            position: fixed; right: 20px; bottom: 20px; width: 360px; height: 550px;
            background: white; border-radius: 16px; display: none; flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 3000; overflow: hidden;
            border: 1px solid var(--border-color);
        }
        [data-theme="dark"] #ai-card { background: #252525; border-color: #333; color: #eee; }

        /* --- æ€ç»´å¯¼å›¾æ ·å¼ --- */
        .mm-container { display: flex; align-items: center; padding: 60px; min-width: fit-content; min-height: fit-content; }
        .mm-tree { display: flex; align-items: center; }
        .mm-tree ul { display: flex; flex-direction: column; padding-left: 40px; position: relative; margin: 0; list-style: none; }
        .mm-tree li { position: relative; display: flex; align-items: center; margin: 10px 0; }
        .mm-node {
            display: inline-block; padding: 8px 12px; border: 1px solid var(--border-color);
            background: var(--ui-bg); border-radius: 6px; font-size: 13px; color: var(--text-color);
            max-width: 260px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            cursor: pointer; z-index: 5; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .mm-node:hover { background: var(--accent-color); color: white; white-space: normal; z-index: 100; transform: scale(1.05); }
        .mm-node.mm-root { background: var(--accent-color); color: white; font-weight: bold; font-size: 16px; padding: 10px 20px; }
        .mm-node.mm-global-note { border: 2px solid var(--accent-color); font-weight: bold; background: var(--card-bg); }
        .mm-node.mm-summary { border-style: dashed; font-style: italic; background: rgba(0,0,0,0.02); border-color: var(--accent-color); min-width: 150px; }
        .mm-tree li::before { content: ''; position: absolute; left: 0; top: 50%; width: 40px; height: 1px; background: var(--accent-color); opacity: 0.4; }
        .mm-tree > li::before { display: none; }
        .mm-tree li::after { content: ''; position: absolute; left: 0; top: 0; width: 1px; height: 100%; background: var(--accent-color); opacity: 0.4; }
        .mm-tree ul > li:first-child::after { top: 50%; height: 50%; }
        .mm-tree ul > li:last-child::after { height: 50%; top: 0; }
        .mm-tree ul > li:only-child::after { display: none; }
        .toggle-btn {
            position: absolute; right: -10px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px;
            background: var(--accent-color); color: white; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 12px; cursor: pointer; z-index: 20;
        }
        .mm-tree li.collapsed > ul { display: none; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 3px; }

        @media (max-width: 640px) {
            .reader-container { padding: 80px 20px; --font-size: 16px; }
            #style-panel { right: 10px; width: 90vw; }
            .sidebar { width: 85vw; }
            .mm-container { padding: 20px; }
        }
    </style>
</head>
<body data-theme="paper">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="top-bar fixed top-0 w-full bg-[var(--ui-bg)] backdrop-blur-md z-50 flex justify-between items-center px-4 py-2 border-b border-[var(--border-color)] immersive-ui shadow-sm">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar('left')" class="p-2 text-xl opacity-70 hover:opacity-100 rounded"><i class="ri-menu-2-line"></i></button>
            <span id="header-title" class="text-sm font-bold truncate max-w-[120px] opacity-90">æç®€æ™ºè¯»</span>
        </div>
        
        <div class="flex gap-1 items-center">
            <button onclick="showDashboard('stats')" class="p-2 opacity-70 hover:opacity-100 rounded text-[var(--accent-color)]" title="æ•°æ®çœ‹æ¿"><i class="ri-pie-chart-2-fill text-lg"></i></button>
            <button onclick="toggleStylePanel()" class="p-2 opacity-70 hover:opacity-100 rounded" title="æ˜¾ç¤ºè®¾ç½®"><i class="ri-t-shirt-line"></i></button>
            <button onclick="openAIChat()" class="p-2 opacity-70 hover:opacity-100 rounded"><i class="ri-chat-smile-3-line text-lg"></i></button>
            <button onclick="toggleSidebar('right')" class="p-2 opacity-70 hover:opacity-100 rounded relative">
                <i class="ri-book-mark-line"></i>
                <span id="note-badge" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full hidden"></span>
            </button>
            <button onclick="showImportModal()" class="ml-2 text-xs border border-[var(--text-color)] opacity-50 hover:opacity-100 px-3 py-1 rounded-full transition">å¯¼å…¥</button>
        </div>
    </header>

    <!-- æ ·å¼è®¾ç½®é¢æ¿ -->
    <div id="style-panel">
        <div class="style-row">
            <span>é…è‰²ä¸»é¢˜</span>
            <div class="grid grid-cols-6 gap-2">
                <div onclick="setTheme('white')" class="color-btn bg-white" title="çº¯ç™½"></div>
                <div onclick="setTheme('dark')" class="color-btn bg-[#1E1E1E]" title="æš—é»‘"></div>
                <div onclick="setTheme('paper')" class="color-btn bg-[#FAF7F2]" title="ç¾Šçš®çº¸"></div>
                <div onclick="setTheme('wall')" class="color-btn bg-[#E3E3E3]" title="é¢å£"></div>
                <div onclick="setTheme('lilac')" class="color-btn bg-[#F8F0FC]" title="é¦™èŠ‹"></div>
                <div onclick="setTheme('green')" class="color-btn bg-[#C7EDCC]" title="æŠ¤çœ¼"></div>
            </div>
        </div>
        <div class="style-row border-t border-[var(--border-color)] pt-3">
            <span>å­—å·</span>
            <div class="flex items-center gap-2 bg-[var(--sidebar-hover)] rounded p-1">
                <button onclick="changeFontSize(-1)" class="px-2 hover:bg-[var(--bg-color)] rounded"><i class="ri-subtract-line"></i></button>
                <span id="font-size-display" class="px-2 text-xs opacity-60">18</span>
                <button onclick="changeFontSize(1)" class="px-2 hover:bg-[var(--bg-color)] rounded"><i class="ri-add-line"></i></button>
            </div>
        </div>
    </div>

    <!-- å·¦ä¾§ç›®å½•æ  -->
    <aside id="sidebar-left" class="sidebar sidebar-left">
        <div class="p-5 border-b border-[var(--border-color)] flex justify-between items-center">
            <h2 class="font-bold text-lg">ç›®å½•</h2>
            <button onclick="toggleSidebar('left')" class="opacity-50 hover:opacity-100"><i class="ri-close-line text-xl"></i></button>
        </div>
        <div class="flex flex-col h-full overflow-hidden">
            <nav id="chapter-list" class="flex-1 overflow-y-auto p-3 text-sm no-scrollbar"></nav>
            <div class="p-3 border-t border-[var(--border-color)]">
                <div onclick="openGlobalNotes()" class="toc-item flex items-center gap-2 text-[var(--accent-color)] bg-[var(--sidebar-hover)]">
                    <i class="ri-book-2-fill"></i>
                    <span class="font-bold">ğŸ“ å…¨ä¹¦æ€ç»´ç¬”è®°</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- å³ä¾§ç¬”è®°æ  -->
    <aside id="sidebar-right" class="sidebar sidebar-right">
        <div class="p-5 border-b border-[var(--border-color)] flex justify-between items-center">
            <h2 class="font-bold text-lg">ç¬”è®° (<span id="selected-count">0</span>)</h2>
            <button onclick="toggleSidebar('right')" class="opacity-50 hover:opacity-100"><i class="ri-close-line text-xl"></i></button>
        </div>
        <div id="notes-list" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm">
            <div class="text-center text-gray-400 mt-10">æš‚æ— ç¬”è®°</div>
        </div>
        <div class="p-4 border-t border-[var(--border-color)] space-y-2">
            <button onclick="openMindMap()" class="w-full bg-[var(--text-color)] text-[var(--bg-color)] py-2 rounded-lg flex items-center justify-center gap-2 hover:opacity-90 shadow-sm transition text-xs">
                <i class="ri-mind-map"></i> å…¨ä¹¦æ€ç»´å¯¼å›¾ (å«ç¬”è®°)
            </button>
            <button onclick="analyzeSelectedNotes()" class="w-full bg-[var(--accent-color)] text-white py-2 rounded-lg flex items-center justify-center gap-2 hover:opacity-90 shadow-sm transition text-xs">
                <i class="ri-magic-line"></i> AI æ·±åº¦åˆ†æ
            </button>
            <button onclick="exportWithData()" class="w-full border border-[var(--text-color)] opacity-40 hover:opacity-80 py-2 rounded-lg text-xs transition">
                <i class="ri-download-line"></i> å¯¼å‡ºæ•°æ® (å«è¿›åº¦ä¸ç¬”è®°)
            </button>
        </div>
    </aside>

    <!-- ä¸»é˜…è¯»åŒºåŸŸ -->
    <main id="reader" class="reader-container shadow-sm" onclick="handleCenterClick(event)">
        <!-- æ­£å¸¸ç« èŠ‚å†…å®¹ -->
        <div id="content" class="markdown-body">
            <div class="text-center py-40">
                <div class="w-20 h-20 bg-[var(--accent-color)] text-white rounded-full flex items-center justify-center mx-auto mb-6 text-3xl shadow-lg opacity-80">
                    <i class="ri-book-open-line"></i>
                </div>
                <h1 class="text-2xl mb-4 opacity-80 font-normal">æç®€æ™ºè¯» v2.5</h1>
                <p class="opacity-50 text-sm">ç‚¹å‡»å³ä¸Šè§’å¯¼å…¥ Markdown æ–‡ä»¶<br>è‡ªåŠ¨è®°å½•é˜…è¯»è¿›åº¦ä¸ç—•è¿¹</p>
            </div>
        </div>
        <!-- å…¨ä¹¦ç¬”è®°ç¼–è¾‘å™¨ (é»˜è®¤éšè—) -->
        <div id="global-editor-container" style="display:none;" class="animate-fade-in relative">
            <div class="flex justify-between items-center border-b border-[var(--border-color)] pb-4 mb-4">
                <h1 class="text-2xl opacity-80">ğŸ“ å…¨ä¹¦æ€ç»´ç¬”è®°</h1>
                <!-- å®æ—¶ä¿å­˜æŒ‰é’® -->
                <button onclick="saveGlobalNotesManually()" class="bg-[var(--accent-color)] text-white px-4 py-2 rounded shadow text-sm hover:opacity-90 transition flex items-center gap-2">
                    <i class="ri-save-3-line"></i> ä¿å­˜å¹¶è®°å½•
                </button>
            </div>
            <textarea id="global-notes-editor" placeholder="åœ¨è¿™é‡Œè®°å½•å…¨ä¹¦çš„å®è§‚æ€è€ƒã€æ—¥å¿—æˆ–å¤‡å¿˜... (ä¼šè‡ªåŠ¨è¿½åŠ æ—¥æœŸ)"></textarea>
        </div>
    </main>

    <!-- æ‚¬æµ®çƒï¼šç‚¹å‡»æ‰“å¼€é˜…è¯»ç—•è¿¹ Log -->
    <div id="float-ball" onclick="showDashboard('log')" title="ç‚¹å‡»æŸ¥çœ‹é˜…è¯»ç—•è¿¹ï¼Œæ‹–æ‹½ç§»åŠ¨">
        <span class="ball-time text-xs font-mono font-bold" id="ball-timer">00:00</span>
    </div>

    <!-- åº•éƒ¨ç¿»é¡µæ  -->
    <footer class="bottom-bar fixed bottom-0 w-full bg-[var(--ui-bg)] backdrop-blur-md py-3 flex justify-around items-center border-t border-[var(--border-color)] immersive-ui z-40 text-sm">
        <button onclick="prevPage()" class="px-4 py-2 opacity-60 hover:opacity-100"><i class="ri-arrow-left-s-line"></i> ä¸Šä¸€ç« </button>
        <span id="page-info" class="text-xs opacity-40 font-mono">0 / 0</span>
        <button onclick="nextPage()" class="px-4 py-2 opacity-60 hover:opacity-100">ä¸‹ä¸€ç«  <i class="ri-arrow-right-s-line"></i></button>
    </footer>

    <!-- æ•°æ®çœ‹æ¿ (Dashboard) -->
    <div id="dashboard-modal" class="fixed inset-0 bg-black/60 hidden z-[5000] items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[var(--ui-bg)] rounded-xl w-full max-w-3xl p-6 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <div class="flex gap-4">
                    <button id="tab-btn-stats" onclick="switchDashTab('stats')" class="dash-tab-btn active">æ•°æ®æ¦‚è§ˆ</button>
                    <button id="tab-btn-log" onclick="switchDashTab('log')" class="dash-tab-btn">é˜…è¯»ç—•è¿¹</button>
                </div>
                <button onclick="closeModal('dashboard-modal')" class="opacity-50 hover:opacity-100"><i class="ri-close-line text-xl"></i></button>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ 1: ç»Ÿè®¡æ¦‚è§ˆ -->
            <div id="dash-content-stats" class="flex-1 overflow-y-auto pr-2">
                <!-- åŸºç¡€ç»Ÿè®¡å¡ç‰‡ -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="stat-card">
                        <div class="stat-value" id="dash-progress">0%</div>
                        <div class="stat-label">é˜…è¯»è¿›åº¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dash-time">0m</div>
                        <div class="stat-label">æ€»æ—¶é•¿</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dash-notes">0</div>
                        <div class="stat-label">ç¬”è®°&åˆ’çº¿</div>
                    </div>
                    <!-- æ–°å¢ï¼šç¼–è¾‘ç»Ÿè®¡ -->
                    <div class="stat-card">
                        <div class="stat-value" id="dash-edit-stats">0</div>
                        <div class="stat-label">æ€»ç»“ä¸ç¬”è®°å­—æ•°</div>
                    </div>
                </div>

                <!-- æ–°å¢ï¼šé˜…è¯»æ´»è·ƒåº¦å›¾è¡¨ (æŒ‰æ—¥æœŸ) -->
                <div class="bg-[var(--card-bg)] rounded-lg border border-[var(--border-color)] p-4 mb-6">
                    <h4 class="font-bold mb-2 text-sm opacity-70">ğŸ“… è¿‘7æ—¥æ´»è·ƒåº¦ (åŸºäºæ“ä½œæ¬¡æ•°)</h4>
                    <div id="activity-chart" class="chart-bar-container">
                        <!-- JS è‡ªåŠ¨ç”Ÿæˆå›¾è¡¨ -->
                        <div class="text-xs opacity-40 w-full text-center">æš‚æ— è¶³å¤Ÿæ•°æ®ç”Ÿæˆå›¾è¡¨</div>
                    </div>
                </div>

                <!-- ç« èŠ‚è¯¦æƒ…è¡¨ -->
                <h4 class="font-bold mb-3 text-sm opacity-70 border-b pb-2 border-[var(--border-color)]">ç« èŠ‚è¯¦æƒ…</h4>
                <div class="bg-[var(--card-bg)] rounded-lg border border-[var(--border-color)]">
                    <div class="chapter-row font-bold opacity-60 bg-[var(--sidebar-hover)]">
                        <span>#</span>
                        <span>ç« èŠ‚æ ‡é¢˜</span>
                        <span class="text-center">ç¬”è®°</span>
                        <span class="text-right">æ€»ç»“</span>
                    </div>
                    <div id="dash-chapter-list">
                        <!-- JS æ¸²æŸ“åˆ—è¡¨ -->
                    </div>
                </div>
            </div>

            <!-- å†…å®¹åŒºåŸŸ 2: ç—•è¿¹ Log -->
            <div id="dash-content-log" class="flex-1 overflow-y-auto pr-2 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-bold text-sm opacity-70">ğŸ‘£ è¡Œä¸ºæ—¥å¿— (Traces)</h4>
                    <span class="text-xs opacity-50">è®°å½•æ¯ä¸€æ¬¡é˜…è¯»ã€ç¬”è®°ä¸æ€è€ƒ</span>
                </div>
                <div id="timeline-list">
                    <!-- JS æ¸²æŸ“ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ°”æ³¡èœå• -->
    <div id="bubble-menu">
        <button onclick="handleHighlight()"><i class="ri-markup-line"></i> åˆ’çº¿</button>
        <button onclick="openNoteModal()"><i class="ri-edit-line"></i> ç¬”è®°</button>
        <button onclick="askAIWithSelection()"><i class="ri-question-answer-line"></i> é—®AI</button>
    </div>
    
    <!-- ç¬”è®°è¯¦æƒ… Popover -->
    <div id="note-popup">
        <div class="flex justify-between items-start mb-2 opacity-50 text-xs">
            <span>ç¬”è®°è¯¦æƒ…</span>
            <button class="hover:text-red-500" id="popup-delete-btn"><i class="ri-delete-bin-line"></i></button>
        </div>
        <div id="popup-content" class="mb-2 text-sm leading-relaxed"></div>
        <div id="popup-comment" class="text-xs bg-black/5 p-2 rounded text-[var(--accent-color)] italic hidden"></div>
    </div>


    <!-- AI åŠ©æ‰‹å¡ç‰‡ -->
    <div id="ai-card">
        <!-- å¤´éƒ¨ï¼šå¢åŠ äº†è®¾ç½®æŒ‰é’® -->
        <div class="bg-[var(--accent-color)] text-white p-3.5 flex justify-between items-center cursor-move" id="ai-header">
            <span class="text-sm font-bold"><i class="ri-robot-fill mr-1"></i> é˜…è¯»åŠ©æ‰‹</span>
            <div class="flex gap-3 text-white/80">
                <button onclick="toggleAISettings()" title="è®¾ç½®æç¤ºè¯"><i class="ri-settings-3-line"></i></button> <!-- [æ–°å¢] -->
                <button onclick="clearChat()" title="æ¸…ç©º"><i class="ri-delete-bin-line"></i></button>
                <button onclick="toggleAICard()"><i class="ri-close-line"></i></button>
            </div>
        </div>
    
        <!-- [ä¿®æ”¹] AI è®¾ç½®é¢æ¿å±‚ -->
        <div id="ai-settings-layer" class="hidden absolute inset-0 top-[50px] bg-white z-20 flex flex-col p-5 animate-fade-in">
            <div class="flex justify-between items-center mb-2">
                <h4 class="font-bold text-sm">AI è§’è‰²è®¾å®š</h4>
                <span class="text-xs text-[var(--accent-color)] cursor-pointer hover:underline" onclick="document.getElementById('ai-prompt-input').value=state.aiPresets[0].prompt">æ¢å¤é»˜è®¤</span>
            </div>
        
            <!-- [æ–°å¢] é¢„è®¾æ ‡ç­¾å®¹å™¨ -->
            <div id="preset-tags" class="flex flex-wrap gap-2 mb-3">
                <!-- JS ä¼šåœ¨è¿™é‡Œè‡ªåŠ¨ç”ŸæˆæŒ‰é’® -->
            </div>
        
            <p class="text-xs text-gray-400 mb-2">ç‚¹å‡»ä¸Šæ–¹æ ‡ç­¾å¯å¿«é€Ÿå¡«å…¥ï¼Œæˆ–åœ¨ä¸‹æ–¹è‡ªç”±ç¼–è¾‘ï¼š</p>
            
            <!-- è¾“å…¥æ¡† -->
            <textarea id="ai-prompt-input" class="w-full border p-3 text-sm rounded flex-1 mb-4 bg-gray-50 focus:outline-[var(--accent-color)] resize-none shadow-inner"></textarea>
            
            <!-- æŒ‰é’®ç»„ -->
            <div class="flex gap-2">
                <button onclick="saveAIPrompt()" class="flex-1 bg-[var(--accent-color)] text-white py-2 rounded text-sm hover:opacity-90 shadow-sm">ä¿å­˜å¹¶ç”Ÿæ•ˆ</button>
                <button onclick="toggleAISettings()" class="flex-1 border border-gray-300 py-2 rounded text-sm hover:bg-gray-50">å–æ¶ˆ</button>
            </div>
        </div>
    
        <!-- åŸæœ‰çš„èŠå¤©åˆ—è¡¨ -->
        <div id="ai-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-stone-50/50 text-sm">
            <div class="bg-white p-3 rounded-lg border shadow-sm text-black/80 text-xs leading-relaxed">
                ğŸ‘‹ æˆ‘æ˜¯ä½ çš„é˜…è¯»åŠ©æ‰‹ã€‚é€‰ä¸­æ–‡å­—æé—®ï¼Œæˆ–ç›´æ¥è¾“å…¥é—®é¢˜ã€‚
            </div>
        </div>
        
        <!-- AI å¡ç‰‡åº•éƒ¨åŒºåŸŸ -->
        <div class="border-t bg-white flex flex-col">
            
            <!-- [æ–°å¢] å¿«æ·æ“ä½œæ  (é»˜è®¤æ˜¾ç¤º) -->
            <div id="ai-quick-actions" class="flex gap-2 overflow-x-auto px-3 py-2 no-scrollbar border-b border-gray-100 bg-gray-50/50 whitespace-nowrap">
                <!-- JS ä¼šåœ¨è¿™é‡Œè‡ªåŠ¨ç”ŸæˆæŒ‰é’® -->
            </div>
        
            <!-- åŸæœ‰çš„è¾“å…¥æ¡†åŒºåŸŸ -->
            <div class="p-3 flex gap-2 relative">
                <input type="text" id="ai-input" placeholder="è¾“å…¥é—®é¢˜..." class="flex-1 border bg-gray-50 rounded-lg px-3 py-2 text-sm focus:outline-none text-black transition-colors focus:bg-white focus:border-[var(--accent-color)]">
                <button onclick="sendAIQuery()" class="bg-[var(--accent-color)] text-white w-9 h-9 rounded-lg flex items-center justify-center hover:opacity-90 shadow-sm"><i class="ri-send-plane-fill"></i></button>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥æ–‡ä»¶ Modal -->
    <div id="import-modal" class="fixed inset-0 bg-black/60 hidden z-[5000] items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[var(--ui-bg)] rounded-xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="font-bold mb-4 text-lg">å¯¼å…¥ä¹¦ç±</h3>
            <input type="password" id="api-key" placeholder="DashScope API Key (é€‰å¡«)" class="w-full border border-[var(--border-color)] bg-black/5 rounded p-3 text-sm mb-4 outline-none">
            <div class="border-2 border-dashed border-[var(--border-color)] rounded-lg p-6 text-center cursor-pointer hover:bg-black/5 transition relative">
                <i class="ri-file-upload-line text-3xl opacity-30 mb-2 block"></i>
                <span class="text-sm opacity-50">ç‚¹å‡»é€‰æ‹© .md æ–‡ä»¶</span>
                <input type="file" id="file-input" accept=".md" class="absolute inset-0 opacity-0 cursor-pointer" onchange="confirmImport()">
            </div>
            <button onclick="closeModal('import-modal')" class="mt-4 w-full py-2 opacity-50 hover:opacity-100 text-sm">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- ç¬”è®°è¾“å…¥ Modal -->
    <div id="note-modal" class="fixed inset-0 bg-black/60 hidden z-[5000] items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl text-black">
            <h3 class="font-bold mb-3">æ·»åŠ æƒ³æ³•</h3>
            <p id="note-ref-text" class="text-xs text-gray-500 italic mb-4 line-clamp-2 border-l-2 border-[var(--accent-color)] pl-2 bg-gray-50 p-2 rounded"></p>
            <textarea id="note-input" rows="4" class="w-full border rounded-lg p-3 text-sm focus:outline-none" placeholder="è®°å½•æƒ³æ³•..."></textarea>
            <div class="flex gap-3 mt-4">
                <button onclick="saveNote()" class="flex-1 bg-stone-800 text-white py-2 rounded-lg shadow">ä¿å­˜</button>
                <button onclick="closeModal('note-modal')" class="flex-1 border py-2 rounded-lg">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç« èŠ‚æ€»ç»“ Modal -->
    <div id="chapter-summary-modal" class="fixed inset-0 bg-black/60 hidden z-[5200] items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl text-black">
            <h3 class="font-bold mb-3">ç« èŠ‚æ€ç»´æ€»ç»“</h3>
            <div class="text-xs opacity-50 mb-2" id="summary-chap-title"></div>
            <textarea id="summary-input" rows="5" class="w-full border rounded-lg p-3 text-sm focus:outline-none" placeholder="æœ¬ç« çš„æ ¸å¿ƒé€»è¾‘æ˜¯ä»€ä¹ˆï¼Ÿ"></textarea>
            <div class="flex gap-3 mt-4">
                <button onclick="saveChapterSummary()" class="flex-1 bg-[var(--accent-color)] text-white py-2 rounded-lg shadow">ä¿å­˜</button>
                <button onclick="closeModal('chapter-summary-modal')" class="flex-1 border py-2 rounded-lg">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ€ç»´å¯¼å›¾ Modal -->
    <div id="mindmap-modal" class="fixed inset-0 bg-[var(--bg-color)] hidden z-[5000] flex-col">
        <div class="p-4 border-b border-[var(--border-color)] flex justify-between items-center bg-[var(--ui-bg)] shadow-sm">
            <h2 class="font-bold">å…¨ä¹¦è„‰ç»œ</h2>
            <div class="text-xs opacity-50 ml-4 hidden sm:block">åŒ…å«ï¼šç« èŠ‚ã€æ€ç»´æ€»ç»“ã€ç¬”è®°èŠ‚ç‚¹</div>
            <button onclick="closeModal('mindmap-modal')" class="p-2 hover:bg-black/5 rounded ml-auto"><i class="ri-close-line text-xl"></i></button>
        </div>
        <div class="flex-1 overflow-auto bg-[var(--bg-color)] relative cursor-grab active:cursor-grabbing" id="mindmap-canvas">
            <div class="mm-container" id="mindmap-root"></div>
        </div>
    </div>

    <script>
        /**
         * å…¨å±€çŠ¶æ€ç®¡ç†å¯¹è±¡
         * å­˜å‚¨åº”ç”¨è¿è¡Œæ—¶çš„æ‰€æœ‰æ ¸å¿ƒæ•°æ®
         */
        let state = {
            chapters: [],              // ç« èŠ‚åˆ—è¡¨ {title, content}
            currentChapterIndex: 0,    // å½“å‰é˜…è¯»ç« èŠ‚ç´¢å¼•
            highlights: [],            // é«˜äº®å’Œç¬”è®°æ•°ç»„ {id, chapter, text, type, comment...}
            chapterSummaries: {},      // ç« èŠ‚æ€»ç»“ {index: text}
            globalNotes: "",           // å…¨ä¹¦æ€ç»´ç¬”è®°å†…å®¹
            aiHistory: [],             // AI å¯¹è¯å†å²
            readLog: [],               // è¡Œä¸ºæ—¥å¿—æ•°ç»„ {time, type, detail}
            apiKey: localStorage.getItem('qwen_key') || '', // AI Key
            selectedText: '',          // å½“å‰é€‰ä¸­çš„æ–‡æœ¬
            readingTime: 0,            // å½“å‰ä¼šè¯é˜…è¯»æ—¶é•¿(ç§’)
            totalTime: 0,              // å†å²æ€»é˜…è¯»æ—¶é•¿(ç§’)
            fileName: 'document.md',   // å¯¼å…¥çš„æ–‡ä»¶å
            originalContent: '',       // åŸå§‹ Markdown æ–‡æœ¬
            theme: localStorage.getItem('theme') || 'paper', // å½“å‰ä¸»é¢˜
            fontSize: parseInt(localStorage.getItem('fontSize')) || 18, // å­—ä½“å¤§å°
            uiVisible: true,           // UI æ˜¾ç¤ºçŠ¶æ€
            editingChapterSummaryIndex: -1, // å½“å‰æ­£åœ¨ç¼–è¾‘æ€»ç»“çš„ç« èŠ‚ID
            isGlobalNoteMode: false ,   // æ˜¯å¦å¤„äºå…¨ä¹¦ç¬”è®°ç¼–è¾‘æ¨¡å¼
            // [æ–°å¢] å½“å‰ç”Ÿæ•ˆçš„ç³»ç»Ÿæç¤ºè¯ (ä¼˜å…ˆè¯»å–æœ¬åœ°å­˜å‚¨)
            systemPrompt: localStorage.getItem('systemPrompt') || "ä½ æ˜¯é˜…è¯»åŠ©æ‰‹ï¼Œè¯·ç”¨ç®€æ´ã€æœ‰å¯å‘æ€§çš„è¯­è¨€å›ç­”ã€‚",
        
            // [æ–°å¢] é¢„è®¾åˆ—è¡¨ (ä½ å¯ä»¥éšæ„åœ¨è¿™é‡Œä¿®æ”¹/å¢åŠ )
            // [ä¿®æ”¹] é¢„è®¾åˆ—è¡¨ï¼šlabelæ˜¯æŒ‰é’®åï¼Œpromptæ˜¯æ‹¼æ¥çš„å‰ç¼€
            aiPresets: [
                { label: "ğŸ§ è§£é‡Š", prompt: "è¯·ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šè¿™æ®µæ–‡å­—çš„æ ¸å¿ƒæ¦‚å¿µï¼š" },
                { label: "ğŸ“ æ€»ç»“", prompt: "è¯·ç®€è¦æ€»ç»“è¿™æ®µæ–‡å­—çš„ä¸»æ—¨ï¼ˆ3ç‚¹ä»¥å†…ï¼‰ï¼š" },
                { label: "ğŸ‡ºğŸ‡¸ ç¿»è¯‘", prompt: "è¯·å°†è¿™æ®µæ–‡å­—ç¿»è¯‘æˆåœ°é“æµç•…çš„ä¸­æ–‡ï¼ˆè‹¥æ˜¯ä¸­æ–‡åˆ™è¯‘ä¸ºè‹±æ–‡ï¼‰ï¼š" },
                { label: "â“ æé—®", prompt: "åŸºäºè¿™æ®µæ–‡å­—ï¼Œå‘æˆ‘æå‡º2ä¸ªå¼•å¯¼æ€è€ƒçš„é—®é¢˜ï¼š" },
                { label: "âš–ï¸ æ‰¹åˆ¤", prompt: "è¯·æŒ‡å‡ºè¿™æ®µè§‚ç‚¹çš„å±€é™æ€§æˆ–é€»è¾‘æ¼æ´ï¼š" }
            ],
        };

        /**
         * åˆå§‹åŒ–å‡½æ•°
         * é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œï¼Œæ¢å¤è®¾ç½®å¹¶ç»‘å®šäº‹ä»¶
         */
        document.addEventListener('DOMContentLoaded', () => {
            setTheme(state.theme);
            applyTypography();
            initDraggables();
            initTimer();
            if(state.apiKey) document.getElementById('api-key').value = state.apiKey;
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­å¼¹çª—
            document.addEventListener('click', (e) => {
                const pop = document.getElementById('note-popup');
                if (pop.style.display === 'block' && !pop.contains(e.target) && !e.target.classList.contains('highlight-text')) {
                    pop.style.display = 'none';
                }
            });

            // ç›‘å¬å…¨ä¹¦ç¬”è®°è¾“å…¥ï¼Œå®æ—¶æ›´æ–° State (ä½†ä¸ç«‹å³å†™Logï¼ŒLogç”±æŒ‰é’®è§¦å‘)
            document.getElementById('global-notes-editor').addEventListener('input', (e) => {
                state.globalNotes = e.target.value;
            });
            renderQuickActions(); // [æ–°å¢]
        });

        /* --- æ—¥å¿—ç³»ç»Ÿä¸æ•°æ®çœ‹æ¿æ ¸å¿ƒ --- */

        /**
         * è®°å½•ç”¨æˆ·è¡Œä¸ºæ—¥å¿—
         * @param {string} type äº‹ä»¶ç±»å‹ (OPEN_CHAPTER, NOTE, HIGHLIGHT, EDIT_GLOBAL ç­‰)
         * @param {string} detail äº‹ä»¶è¯¦æƒ…æè¿°
         * @param {boolean} persist æ˜¯å¦æŒä¹…åŒ–ä¿å­˜ (éƒ¨åˆ†é«˜é¢‘åŠ¨ä½œå¯è®¾ä¸ºfalse)
         */
        function logEvent(type, detail, persist = true) {
            if(persist) {
                state.readLog.push({ time: Date.now(), type, detail });
            }
            console.log(`[Log] ${type}: ${detail}`);
        }

        /**
         * æ˜¾ç¤ºæ•°æ®çœ‹æ¿
         * @param {string} tab é»˜è®¤æ‰“å¼€çš„æ ‡ç­¾é¡µ ('stats' | 'log')
         */
        function showDashboard(tab = 'stats') {
            document.getElementById('dashboard-modal').style.display = 'flex';
            switchDashTab(tab);
            updateDashboardData();
        }

        /**
         * åˆ‡æ¢çœ‹æ¿æ ‡ç­¾é¡µ
         */
        function switchDashTab(tab) {
            const statsBtn = document.getElementById('tab-btn-stats');
            const logBtn = document.getElementById('tab-btn-log');
            const statsContent = document.getElementById('dash-content-stats');
            const logContent = document.getElementById('dash-content-log');

            if(tab === 'stats') {
                statsBtn.classList.add('active'); logBtn.classList.remove('active');
                statsContent.classList.remove('hidden'); logContent.classList.add('hidden');
            } else {
                logBtn.classList.add('active'); statsBtn.classList.remove('active');
                logContent.classList.remove('hidden'); statsContent.classList.add('hidden');
            }
        }

        /**
         * æ¸²æŸ“å›¾è¡¨ï¼šæœ€è¿‘7å¤©é˜…è¯»æ´»è·ƒåº¦
         * åŸºäº state.readLog ä¸­çš„æ—¶é—´æˆ³è¿›è¡Œèšåˆ
         */
        function renderActivityChart() {
            const chartContainer = document.getElementById('activity-chart');
            const logs = state.readLog;
            if(!logs || logs.length === 0) {
                chartContainer.innerHTML = '<div class="text-xs opacity-40 w-full text-center">æš‚æ— é˜…è¯»æ•°æ®</div>';
                return;
            }

            // 1. ç”Ÿæˆæœ€è¿‘7å¤©çš„æ—¥æœŸ Key (YYYY-MM-DD)
            const days = [];
            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; // key for matching
                const label = `${d.getMonth()+1}/${d.getDate()}`; // label for display
                days.push({ key, label, count: 0 });
            }

            // 2. ç»Ÿè®¡æ¯å¤©çš„æ“ä½œæ¬¡æ•°
            logs.forEach(log => {
                const d = new Date(log.time);
                const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
                const target = days.find(day => day.key === key);
                if(target) target.count++;
            });

            // 3. è®¡ç®—æœ€å¤§å€¼ç”¨äºå½’ä¸€åŒ–é«˜åº¦
            const maxCount = Math.max(...days.map(d => d.count), 1); // é¿å…é™¤ä»¥0

            // 4. ç”Ÿæˆ HTML
            const html = days.map(day => {
                const heightPercent = Math.max((day.count / maxCount) * 100, 5); // æœ€å°é«˜åº¦5%
                const barColor = day.count > 0 ? 'var(--accent-color)' : 'var(--border-color)';
                const opacity = day.count > 0 ? '1' : '0.3';
                
                return `
                <div class="chart-bar-wrapper">
                    <div class="chart-bar" style="height: ${heightPercent}%; background: ${barColor}; opacity: ${opacity}" title="${day.key}: ${day.count}æ¬¡æ“ä½œ"></div>
                    <div class="chart-label">${day.label}</div>
                </div>`;
            }).join('');

            chartContainer.innerHTML = html;
        }

        /**
         * æ›´æ–°çœ‹æ¿ä¸­çš„æ‰€æœ‰æ•°æ®
         */
        function updateDashboardData() {
            // 1. é¡¶éƒ¨åŸºç¡€ç»Ÿè®¡
            const readCount = state.readLog.filter(l => l.type === 'OPEN_CHAPTER').map(l=>l.detail).filter((v,i,a)=>a.indexOf(v)===i).length;
            const progress = state.chapters.length ? Math.round((readCount / state.chapters.length) * 100) : 0;
            const noteCount = state.highlights.length;
            const totalMin = Math.floor((state.totalTime + state.readingTime) / 60);

            document.getElementById('dash-progress').innerText = `${progress}%`;
            document.getElementById('dash-notes').innerText = noteCount;
            document.getElementById('dash-time').innerText = totalMin < 60 ? `${totalMin}m` : `${(totalMin/60).toFixed(1)}h`;

            // 2. æ–°å¢ï¼šç¼–è¾‘ç»Ÿè®¡ (æ€»ç»“æ•° + å…¨ä¹¦ç¬”è®°å­—æ•°)
            const summaryCount = Object.keys(state.chapterSummaries).length;
            const globalNoteLen = state.globalNotes.length;
            document.getElementById('dash-edit-stats').innerText = `${summaryCount} / ${globalNoteLen}å­—`;

            // 3. æ¸²æŸ“å›¾è¡¨
            renderActivityChart();

            // 4. ç« èŠ‚æ¦‚è§ˆè¡¨æ ¼
            const chapterListEl = document.getElementById('dash-chapter-list');
            if (state.chapters.length === 0) {
                chapterListEl.innerHTML = '<div class="p-4 text-center opacity-50">è¯·å…ˆå¯¼å…¥ä¹¦ç±</div>';
            } else {
                chapterListEl.innerHTML = state.chapters.map((chap, idx) => {
                    const cNotes = state.highlights.filter(h => h.chapter === idx).length;
                    const hasSummary = !!state.chapterSummaries[idx];
                    return `
                    <div class="chapter-row cursor-pointer" onclick="closeModal('dashboard-modal');renderChapter(${idx})">
                        <span class="opacity-50">${idx+1}</span>
                        <span class="truncate font-medium">${chap.title}</span>
                        <span class="text-center opacity-70">${cNotes > 0 ? cNotes : '-'}</span>
                        <span class="text-right">${hasSummary ? '<i class="ri-check-line text-green-500"></i>' : '<span class="opacity-30 text-xs">æ— </span>'}</span>
                    </div>`;
                }).join('');
            }

            // 5. æ—¶é—´è½´æ¸²æŸ“ (å€’åº)
            const list = document.getElementById('timeline-list');
            let combined = state.readLog.map(l => ({...l, isLog: true}));
            combined.sort((a,b) => b.time - a.time); 

            if(combined.length === 0) {
                list.innerHTML = '<div class="text-center opacity-50 py-4">æš‚æ— æ•°æ®è®°å½•</div>';
            } else {
                let html = '<div class="timeline-container">';
                combined.forEach(item => {
                    const date = new Date(item.time);
                    const timeStr = `${date.getMonth()+1}-${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                    let icon = 'ri-circle-fill';
                    let label = 'è®°å½•';

                    // æ ¹æ®ç±»å‹åˆ†é…å›¾æ ‡
                    if(item.type === 'OPEN_CHAPTER') { icon = 'ri-book-open-line'; label = 'é˜…è¯»ç« èŠ‚'; }
                    else if(item.type === 'NOTE') { icon = 'ri-edit-line'; label = 'æƒ³æ³•ç¬”è®°'; }
                    else if(item.type === 'HIGHLIGHT') { icon = 'ri-mark-pen-line'; label = 'åˆ’çº¿'; }
                    else if(item.type === 'SUMMARY') { icon = 'ri-file-list-3-line'; label = 'ç« èŠ‚æ€»ç»“'; }
                    else if(item.type === 'EXPORT') { icon = 'ri-save-line'; label = 'å¯¼å‡ºå¤‡ä»½'; }
                    else if(item.type === 'EDIT_GLOBAL') { icon = 'ri-save-3-line'; label = 'å…¨ä¹¦ç¬”è®°'; }

                    html += `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-time">${timeStr} â€¢ <i class="${icon}"></i> ${label}</div>
                            <div class="opacity-90 break-words">${item.detail}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
                list.innerHTML = html;
            }
        }

        /* --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ --- */

        /**
         * æ‰“å¼€å…¨ä¹¦ç¬”è®°æ¨¡å¼
         */
        function openGlobalNotes() {
            state.isGlobalNoteMode = true;
            document.getElementById('content').style.display = 'none';
            document.getElementById('global-editor-container').style.display = 'block';
            document.getElementById('page-info').innerText = "Editor Mode";
            
            // è‡ªåŠ¨æ’å…¥å½“å¤©æ—¥æœŸæ ‡é¢˜ï¼Œæ–¹ä¾¿å†™æ—¥è®°
            const today = new Date().toISOString().split('T')[0];
            const header = `### ${today}`;
            if (!state.globalNotes.trim().endsWith(header) && !state.globalNotes.includes(header + "\n")) {
                if(state.globalNotes) state.globalNotes += "\n\n";
                state.globalNotes += header + "\n";
            }
            document.getElementById('global-notes-editor').value = state.globalNotes;
            if(window.innerWidth < 640) toggleSidebar('left');
            
            // æ³¨æ„ï¼šå•çº¯æ‰“å¼€ä¸è®°Logï¼Œç‚¹å‡»ä¿å­˜æ‰è®°
        }

        /**
         * æ‰‹åŠ¨ä¿å­˜å…¨ä¹¦ç¬”è®°å¹¶è®°å½•æ—¥å¿— (æ–°å¢åŠŸèƒ½)
         */
        function saveGlobalNotesManually() {
            const currentLength = state.globalNotes.length;
            // æ¨¡æ‹Ÿä¿å­˜ï¼ˆå®é™…ä¸Šå˜é‡å·²ç»é€šè¿‡ input äº‹ä»¶æ›´æ–°äº†ï¼‰
            
            // è®°å½•æ—¥å¿—
            logEvent('EDIT_GLOBAL', `æ›´æ–°å…¨ä¹¦æ€ç»´ç¬”è®° (å½“å‰å­—æ•°: ${currentLength})`);
            
            // è§†è§‰åé¦ˆ
            const btn = document.querySelector('#global-editor-container button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ri-check-line"></i> å·²è®°å½•';
            btn.classList.add('bg-green-600');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('bg-green-600');
            }, 1500);
        }

        /**
         * æ¸²æŸ“å·¦ä¾§ç›®å½•
         */
        function renderTOC() {
            const list = document.getElementById('chapter-list');
            list.innerHTML = state.chapters.map((c, i) => {
                const isActive = i === state.currentChapterIndex && !state.isGlobalNoteMode;
                const summary = state.chapterSummaries[i];
                return `
                <div class="toc-item ${isActive ? 'active' : ''}">
                    <div onclick="renderChapter(${i})" class="font-medium truncate flex items-center gap-2">
                        ${isActive ? '<i class="ri-arrow-right-s-fill"></i>' : ''} ${c.title}
                    </div>
                    <div class="toc-summary-box">
                        <div onclick="renderChapter(${i})">
                            ${summary ? `<i class="ri-chat-quote-line text-[var(--accent-color)]"></i> ${summary}` : '<span class="italic opacity-50">ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®æ·»åŠ æ€»ç»“...</span>'}
                        </div>
                        <div class="toc-actions">
                            <button onclick="openChapterSummary(${i}, event)" class="toc-btn" title="ç¼–å†™æ€»ç»“"><i class="ri-edit-line"></i> ç¼–è¾‘</button>
                            <button onclick="askAIAboutChapter(${i}, event)" class="toc-btn" title="AIæé—®"><i class="ri-robot-line"></i> æé—®</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        /**
         * è§£æ Markdown æ–‡ä»¶
         * åŒ…å«åˆ†ç¦»æ­£æ–‡å’Œéšè—çš„ JSON æ•°æ®å—
         */
        function parseMarkdown(md) {
            // å°è¯•è¯»å–æ–‡ä»¶å°¾éƒ¨çš„éšè— JSON æ•°æ®
            const dataMatch = md.match(/<!-- READER_DATA_START([\s\S]*?)READER_DATA_END -->/);
            state.originalContent = md.replace(/<!-- READER_DATA_START[\s\S]*?READER_DATA_END -->/, '').replace(/\n\n# é™„å½•ï¼šå…¨ä¹¦æ€ç»´ç¬”è®°[\s\S]*/, '');
            
            if (dataMatch) {
                try {
                    const saved = JSON.parse(dataMatch[1]);
                    // æ¢å¤çŠ¶æ€
                    state.highlights = saved.highlights || [];
                    state.chapterSummaries = saved.chapterSummaries || {};
                    state.globalNotes = saved.globalNotes || "";
                    state.readLog = saved.readLog || [];
                    state.totalTime = saved.totalTime || 0;
                    
                    if(saved.lastChapter !== undefined) setTimeout(()=>renderChapter(saved.lastChapter), 100);
                } catch(e) { console.error('æ•°æ®è§£æå¤±è´¥', e); }
            }
            
            // ç®€å•çš„ H1 åˆ†ç« é€»è¾‘
            const sections = state.originalContent.split(/^#\s+/m);
            const chapters = [];
            if (sections[0].trim()) chapters.push({ title: 'å‰è¨€/ç®€ä»‹', content: sections[0] });
            for (let i = 1; i < sections.length; i++) {
                const lines = sections[i].split('\n');
                chapters.push({ title: lines[0].trim(), content: '# ' + sections[i] });
            }
            state.chapters = chapters;
            if(!dataMatch) renderChapter(0);
            closeModal('import-modal');
        }

        /**
         * æ¸²æŸ“ç‰¹å®šç« èŠ‚
         */
        function renderChapter(index) {
            if (state.isGlobalNoteMode) {
                state.isGlobalNoteMode = false;
                document.getElementById('content').style.display = 'block';
                document.getElementById('global-editor-container').style.display = 'none';
            }
            if (index < 0 || index >= state.chapters.length) return;
            state.currentChapterIndex = index;
            // æ¸²æŸ“ Markdown
            document.getElementById('content').innerHTML = marked.parse(state.chapters[index].content);
            applyHighlights(); // åº”ç”¨é«˜äº®
            renderTOC(); 
            document.getElementById('page-info').innerText = `${index + 1} / ${state.chapters.length}`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // ç§»åŠ¨ç«¯è‡ªåŠ¨æ”¶èµ·ä¾§è¾¹æ 
            if(window.innerWidth < 640) document.getElementById('sidebar-left').classList.remove('active');
            
            // è®°å½•æ—¥å¿—ï¼ˆé˜²æ­¢é‡å¤è®°å½•åŒä¸€ç« ï¼‰
            const title = state.chapters[index].title;
            const lastLog = state.readLog[state.readLog.length-1];
            if(!lastLog || lastLog.type !== 'OPEN_CHAPTER' || lastLog.detail !== title) {
                logEvent('OPEN_CHAPTER', title);
            }
        }

        /**
         * å°†é«˜äº®åº”ç”¨åˆ° DOM ä¸­
         */
        function applyHighlights() {
            const container = document.getElementById('content');
            let html = marked.parse(state.chapters[state.currentChapterIndex].content);
            const currentHighlights = state.highlights.filter(h => h.chapter === state.currentChapterIndex).sort((a,b) => b.text.length - a.text.length);
            
            // ç®€å•çš„å­—ç¬¦ä¸²æ›¿æ¢å®ç°é«˜äº®ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨æ›´å¥å£®çš„ Range è¿˜åŸï¼‰
            currentHighlights.forEach(h => {
                const marker = h.type === 'note' ? `<i class="ri-chat-1-fill text-[var(--accent-color)] text-xs ml-1 align-top"></i>` : '';
                const span = `<span class="highlight-text" onclick="showNoteDetail(${h.id}, event)">${h.text}${marker}</span>`;
                html = html.split(h.text).join(span);
            });
            container.innerHTML = html;
        }

        /**
         * å¯¼å‡ºåŒ…å«æ•°æ®çš„æ–‡ä»¶
         * å°† State åºåˆ—åŒ–ä¸º JSON å¹¶è¿½åŠ åˆ° Markdown å°¾éƒ¨
         */
        function exportWithData() {
            if (!state.chapters.length) { alert("æ— å†…å®¹å¯å¯¼å‡º"); return; }
            logEvent('EXPORT', 'å¯¼å‡ºæ•°æ®å¤‡ä»½');
            
            const dataToSave = { 
                highlights: state.highlights, 
                lastChapter: state.currentChapterIndex, 
                chapterSummaries: state.chapterSummaries,
                globalNotes: state.globalNotes,
                readLog: state.readLog,
                totalTime: state.totalTime + state.readingTime, // ç´¯åŠ æ—¶é—´
                timestamp: Date.now() 
            };
            
            let contentToSave = state.originalContent;
            // é™„å½•å½¢å¼è¿½åŠ ç¬”è®°ï¼Œæ–¹ä¾¿æ™®é€šé˜…è¯»å™¨æŸ¥çœ‹
            if (state.globalNotes.trim()) {
                contentToSave += `\n\n# é™„å½•ï¼šå…¨ä¹¦æ€ç»´ç¬”è®°\n\n${state.globalNotes}`;
            }
            // éšè—æ•°æ®å—ï¼Œç”¨äºæœ¬è½¯ä»¶è¿˜åŸ
            const footer = `\n\n<!-- READER_DATA_START${JSON.stringify(dataToSave)}READER_DATA_END -->`;
            contentToSave += footer;
            
            const dateStr = new Date().toISOString().split('T')[0]; 
            const baseName = state.fileName.replace(/\.md$/i, '') || 'reading-notes';
            const exportName = `${baseName}-${dateStr}.md`;
            
            // è§¦å‘ä¸‹è½½
            const blob = new Blob([contentToSave], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = exportName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        /* --- æ€ç»´å¯¼å›¾é€»è¾‘ --- */
        function openMindMap() {
            if (state.chapters.length === 0) return alert('è¯·å…ˆå¯¼å…¥ä¹¦ç±');
            renderMindMap();
            document.getElementById('mindmap-modal').style.display = 'flex';
            if(window.innerWidth < 640) document.getElementById('sidebar-right').classList.remove('active');
        }

        function renderMindMap() {
            const rootEl = document.getElementById('mindmap-root');
            const bookName = state.fileName.replace('.md', '');
            let html = `<ul class="mm-tree"><li><span class="mm-node mm-root">${bookName}</span><ul>`;
            
            // èŠ‚ç‚¹ï¼šå…¨ä¹¦ç¬”è®°
            const globalNotePreview = state.globalNotes ? state.globalNotes.substring(0, 15) + "..." : "ç‚¹å‡»ç¼–è¾‘å…¨ä¹¦ç¬”è®°";
            html += `<li><span class="mm-node mm-global-note" onclick="closeModal('mindmap-modal');openGlobalNotes()">ğŸ“ å…¨ä¹¦æ€ç»´ç¬”è®°</span><div class="toggle-btn" onclick="toggleMapNode(this)">+</div><ul class="hidden"><li><span class="mm-node italic opacity-70">${globalNotePreview}</span></li></ul></li>`;

            // èŠ‚ç‚¹ï¼šå„ç« èŠ‚
            state.chapters.forEach((chap, idx) => {
                const chapterNotes = state.highlights.filter(h => h.chapter === idx);
                const summary = state.chapterSummaries[idx];
                let childrenHtml = ''; let hasChildren = false;
                
                // æ€»ç»“èŠ‚ç‚¹
                if (summary) { 
                    childrenHtml += `<li><span class="mm-node mm-summary" title="${summary}" onclick="openChapterSummary(${idx})">ğŸ“ æ€»ç»“: ${summary.substring(0,12)}...</span></li>`; 
                    hasChildren = true; 
                } else {
                    childrenHtml += `<li><span class="mm-node mm-summary opacity-50" onclick="openChapterSummary(${idx})">+ æ·»åŠ æ€»ç»“</span></li>`;
                    hasChildren = true;
                }
                
                // ç¬”è®°èŠ‚ç‚¹
                if (chapterNotes.length > 0) { 
                    childrenHtml += chapterNotes.map(n => `<li><span class="mm-node" onclick="closeModal('mindmap-modal');renderChapter(${n.chapter});setTimeout(()=>showNoteDetail(${n.id}, {target: document.querySelectorAll('.highlight-text')[0], stopPropagation:()=>{}}), 500)" title="${n.text}">${n.type==='note'?'ğŸ’¡':''} ${n.text.substring(0,10)}...</span></li>`).join(''); 
                    hasChildren = true; 
                }
                
                const toggleBtn = hasChildren ? `<div class="toggle-btn" onclick="toggleMapNode(this)">-</div>` : '';
                html += `<li><span class="mm-node" onclick="closeModal('mindmap-modal');renderChapter(${idx})">${chap.title}</span>${toggleBtn}${hasChildren ? `<ul>${childrenHtml}</ul>` : ''}</li>`;
            });
            html += `</ul></li></ul>`;
            rootEl.innerHTML = html;
        }

        /* --- è¾…åŠ©åŠŸèƒ½ä¸ UI äº¤äº’ --- */
        
        // æ‹–æ‹½åŠŸèƒ½åˆå§‹åŒ–
        function initDraggables() {
            makeDraggable(document.getElementById('ai-header'), document.getElementById('ai-card'));
            makeDraggable(document.getElementById('float-ball'), document.getElementById('float-ball'), true);
        }
        
        // é€šç”¨æ‹–æ‹½é€»è¾‘
        function makeDraggable(handle, target, isClickable = false) {
            let isDragging = false, startX, startY, initialLeft, initialTop, hasMoved = false;
            const start = (e) => {
                if(e.target.closest('button')) return;
                isDragging = true; hasMoved = false;
                const c = e.touches ? e.touches[0] : e;
                startX = c.clientX; startY = c.clientY;
                const rect = target.getBoundingClientRect();
                initialLeft = rect.left; initialTop = rect.top;
                target.style.transition='none';
            };
            const move = (e) => {
                if (!isDragging) return;
                const c = e.touches ? e.touches[0] : e;
                const dx = c.clientX - startX; const dy = c.clientY - startY;
                if (Math.abs(dx)>3 || Math.abs(dy)>3) hasMoved = true;
                if (hasMoved) e.preventDefault(); 
                target.style.left = (initialLeft + dx) + 'px';
                target.style.top = (initialTop + dy) + 'px';
            };
            const end = (e) => { 
                isDragging = false; target.style.transition='all 0.2s';
            };
            handle.addEventListener('mousedown', start); document.addEventListener('mousemove', move); document.addEventListener('mouseup', end);
            handle.addEventListener('touchstart', start, {passive:false}); document.addEventListener('touchmove', move, {passive:false}); handle.addEventListener('touchend', end);
        }
        
        // ç‚¹å‡»ä¸­å¤®åˆ‡æ¢æ²‰æµ¸æ¨¡å¼
        function handleCenterClick(e) {
            if (e.target.closest('a') || e.target.closest('.highlight-text') || e.target.closest('textarea') || window.getSelection().toString()) return;
            state.uiVisible = !state.uiVisible;
            document.body.classList.toggle('ui-hidden', !state.uiVisible);
            if(!state.uiVisible) document.getElementById('style-panel').style.display = 'none';
        }

        // ä¾§è¾¹æ å¼€å…³
        function toggleSidebar(s) { 
            const el = document.getElementById('sidebar-'+s); 
            el.classList.toggle('active'); 
            if(s==='right' && el.classList.contains('active')) renderNotesSidebar(); 
        }

        // AI æé—®ç« èŠ‚å†…å®¹
        function askAIAboutChapter(index, e) {
            if(e) e.stopPropagation();
            document.getElementById('sidebar-left').classList.remove('active');
            toggleAICard(true);
            const chap = state.chapters[index];
            const summary = state.chapterSummaries[index] || "æš‚æ— æ€»ç»“";
            let contextContent = chap.content.length > 3000 ? chap.content.substring(0, 3000) + "..." : chap.content;
            const prompt = `æˆ‘æ­£åœ¨é˜…è¯»ã€Š${chap.title}ã€‹ã€‚\næ€»ç»“ï¼š${summary}\n\nå†…å®¹ç‰‡æ®µï¼š\n${contextContent}\n\nè¯·å›ç­”ï¼š`;
            document.getElementById('ai-input').value = prompt;
        }

        // 3. [æ–°å¢] æ‰§è¡Œå¿«æ·æ“ä½œ (æ‹¼æ¥ + å‘é€)
        function sendQuickAction(promptPrefix) {
            const input = document.getElementById('ai-input');
            let currentText = input.value.trim();
            
            // é€»è¾‘åˆ¤æ–­ï¼šå¦‚æœè¾“å…¥æ¡†é‡Œå·²ç»æœ‰åˆšæ‰è‡ªåŠ¨å¡«å…¥çš„å¼•ç”¨æ–‡æœ¬
            if (currentText.includes('> ')) {
                // æ‹¼æ¥ï¼šé¢„è®¾æç¤ºè¯ + æ¢è¡Œ + è¾“å…¥æ¡†é‡Œçš„å¼•ç”¨å†…å®¹
                // ä¾‹å¦‚ï¼š "è¯·è§£é‡Šï¼š\n\n > é€‰ä¸­çš„æ–‡å­—..."
                const finalQuery = `${promptPrefix}\n\n${currentText}`;
                
                // è°ƒç”¨å‘é€é€»è¾‘ï¼Œä¼ å…¥ç»„è£…å¥½çš„æ–‡æœ¬
                sendAIQuery(finalQuery);
                
            } else {
                // å¦‚æœè¾“å…¥æ¡†æ˜¯ç©ºçš„ï¼Œæˆ–è€…ç”¨æˆ·è‡ªå·±å†™çš„å­—ï¼Œç›´æ¥æŠŠæç¤ºè¯åŠ åœ¨å‰é¢
                input.value = promptPrefix + input.value;
                input.focus();
            }
        }

        // å‘é€ AI è¯·æ±‚ (è°ƒç”¨ DashScope API)
        // 4. [ä¿®æ”¹] å‘é€å‡½æ•°ï¼Œæ”¯æŒç›´æ¥ä¼ å…¥ content å‚æ•°
        async function sendAIQuery(directContent = null) {
            const input = document.getElementById('ai-input'); 
            
            // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„å†…å®¹ï¼Œå¦åˆ™è¯»å–è¾“å…¥æ¡†
            const q = directContent || input.value.trim(); 
            
            if(!q) return;
            if(!state.apiKey) { showImportModal(); return; }
            
            input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        
            const msgBox = document.getElementById('ai-messages');
            
            // ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡
            const uDiv = document.createElement('div'); 
            uDiv.className = 'bg-[var(--accent-color)] text-white p-3 rounded-lg rounded-br-none self-end ml-8 text-sm shadow-sm whitespace-pre-wrap'; // [ä¿®æ”¹] å¢åŠ  whitespace-pre-wrap æ”¯æŒæ¢è¡Œæ˜¾ç¤º
            uDiv.innerText = q; 
            msgBox.appendChild(uDiv);
            
            state.aiHistory.push({role: 'user', content: q}); 
            
            // AI Loading æ°”æ³¡
            const loadId = 'msg-' + Date.now();
            const aDiv = document.createElement('div'); 
            aDiv.className = 'bg-white text-black/80 p-3 rounded-lg rounded-bl-none mr-8 border text-sm shadow-sm'; 
            aDiv.id = loadId; 
            aDiv.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> æ€è€ƒä¸­...'; 
            msgBox.appendChild(aDiv); 
            msgBox.scrollTop = msgBox.scrollHeight;
        
            try {
                const res = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                    method: 'POST', 
                    headers: {'Authorization': `Bearer ${state.apiKey}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        model: "qwen-turbo", 
                        // è¿™é‡Œä¾ç„¶ä½¿ç”¨ systemPrompt ä½œä¸ºåº•å±‚çš„è§’è‰²è®¾å®š
                        messages: [{role:"system",content: state.systemPrompt}, ...state.aiHistory.slice(-6)]
                    })
                });
                const data = await res.json(); 
                const reply = data.choices[0].message.content;
                document.getElementById(loadId).innerHTML = marked.parse(reply);
                state.aiHistory.push({role: 'assistant', content: reply}); 
                msgBox.scrollTop = msgBox.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            } catch(e) { 
                document.getElementById(loadId).innerText = 'è¯·æ±‚å¤±è´¥: ' + e.message; 
            }
        }

        // AI åˆ†æé€‰ä¸­çš„ç¬”è®°
        function analyzeSelectedNotes() {
            const sels = state.highlights.filter(n => n.selected);
            if (!sels.length) return alert('è¯·å…ˆåœ¨ä¾§è¾¹æ å‹¾é€‰ç¬”è®°');
            toggleAICard(true);
            const content = sels.map((n, i) => `${i + 1}. [${n.type}] "${n.text}" ${n.comment ? 'æƒ³æ³•:' + n.comment : ''}`).join('\n');
            document.getElementById('ai-input').value = `åˆ†æä»¥ä¸‹ç¬”è®°çš„æ ¸å¿ƒè§‚ç‚¹ï¼š\n${content}`;
            sendAIQuery();
        }

        // UI æ“ä½œå‡½æ•°ç¾¤
        function openNoteModal() { document.getElementById('note-ref-text').innerText = state.selectedText; document.getElementById('note-modal').style.display = 'flex'; document.getElementById('bubble-menu').style.display = 'none'; }
        function showImportModal() { document.getElementById('import-modal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // ç¡®è®¤å¯¼å…¥æ–‡ä»¶
        function confirmImport() {
            const k = document.getElementById('api-key').value;
            const f = document.getElementById('file-input').files[0];
            if(k) { state.apiKey=k; localStorage.setItem('qwen_key', k); }
            if(f) { state.fileName = f.name; const r = new FileReader(); r.onload = e => parseMarkdown(e.target.result); r.readAsText(f); }
            else { document.getElementById('file-input').click(); }
        }

        // ç›‘å¬æ–‡æœ¬é€‰ä¸­ï¼Œæ˜¾ç¤ºæ°”æ³¡èœå•
        function handleSelection() {
            const sel = window.getSelection(); const text = sel.toString().trim(); const menu = document.getElementById('bubble-menu');
            if (text.length === 0 || !document.getElementById('content').contains(sel.anchorNode)) { menu.style.display = 'none'; return; }
            state.selectedText = text;
            const rect = sel.getRangeAt(0).getBoundingClientRect();
            menu.style.display = 'flex'; menu.style.top = (rect.bottom + window.scrollY + 8) + 'px'; menu.style.left = (rect.left + rect.width / 2) + 'px';
        }

        // ä¿å­˜åˆ’çº¿
        function handleHighlight() { 
            state.highlights.push({ id: Date.now(), chapter: state.currentChapterIndex, text: state.selectedText, type: 'highlight' }); 
            logEvent('HIGHLIGHT', `åˆ’çº¿: ${state.selectedText.substring(0,10)}...`);
            finishAnnotation(); 
        }

        // ä¿å­˜ç¬”è®°
        function saveNote() { 
            const val = document.getElementById('note-input').value; 
            if(val) { 
                state.highlights.push({ id: Date.now(), chapter: state.currentChapterIndex, text: state.selectedText, type: 'note', comment: val }); 
                logEvent('NOTE', `ç¬”è®°: ${val.substring(0,10)}...`);
                finishAnnotation(); 
            } 
        }

        // å®Œæˆæ ‡æ³¨åçš„æ¸…ç†å·¥ä½œ
        function finishAnnotation() { applyHighlights(); closeModal('note-modal'); document.getElementById('bubble-menu').style.display = 'none'; document.getElementById('note-input').value = ''; document.getElementById('note-badge').classList.remove('hidden'); window.getSelection().removeAllRanges(); renderNotesSidebar(); }
        
        // æ¸²æŸ“å³ä¾§ç¬”è®°åˆ—è¡¨
        function renderNotesSidebar() {
            const list = document.getElementById('notes-list');
            document.getElementById('selected-count').innerText = state.highlights.filter(n=>n.selected).length;
            list.innerHTML = state.highlights.map(n => `
                <div class="bg-black/5 p-3 rounded-lg relative group transition hover:bg-black/10">
                    <div class="flex gap-2">
                        <input type="checkbox" class="mt-1" onchange="toggleNoteSel(${n.id}, this.checked)" ${n.selected?'checked':''}>
                        <div class="flex-1 cursor-pointer" onclick="renderChapter(${n.chapter})">
                            <div class="text-xs opacity-40 mb-1">ç¬¬ ${n.chapter+1} ç« </div>
                            <div class="border-l-2 border-[var(--accent-color)] pl-2 text-[var(--text-color)] opacity-90 mb-2 font-serif">"${n.text}"</div>
                            ${n.comment ? `<div class="text-xs bg-white/60 p-2 rounded text-black/80">${n.comment}</div>` : ''}
                        </div>
                        <button onclick="deleteNote(${n.id})" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600"><i class="ri-delete-bin-line"></i></button>
                    </div>
                </div>`).join('');
        }

        // æ˜¾ç¤ºç¬”è®°è¯¦æƒ…æ°”æ³¡
        function showNoteDetail(id, e) {
            e.stopPropagation(); const n = state.highlights.find(x => x.id === id); if (!n) return;
            const pop = document.getElementById('note-popup');
            document.getElementById('popup-content').innerText = n.text;
            const pComment = document.getElementById('popup-comment');
            if (n.comment) { pComment.innerText = n.comment; pComment.classList.remove('hidden'); } else { pComment.classList.add('hidden'); }
            document.getElementById('popup-delete-btn').onclick = () => { deleteNote(id); pop.style.display = 'none'; };
            pop.style.display = 'block';
            const rect = e.target.getBoundingClientRect();
            let left = rect.left + (rect.width/2) - 130 + window.scrollX;
            pop.style.left = left + 'px'; pop.style.top = (rect.bottom + window.scrollY + 8) + 'px';
        }

        function toggleNoteSel(id, checked) { state.highlights.find(n=>n.id===id).selected = checked; renderNotesSidebar(); }
        function deleteNote(id) { state.highlights = state.highlights.filter(n=>n.id!==id); renderNotesSidebar(); applyHighlights(); }
        
        // é˜…è¯»è®¡æ—¶å™¨ (æ¯ç§’è§¦å‘)
        function initTimer() { setInterval(() => { state.readingTime++; const m = Math.floor(state.readingTime / 60).toString().padStart(2, '0'); const s = (state.readingTime % 60).toString().padStart(2, '0'); document.getElementById('ball-timer').innerText = `${m}:${s}`; }, 1000); }
        
        // ç¿»é¡µé€»è¾‘
        function prevPage() { if(state.currentChapterIndex>0) renderChapter(state.currentChapterIndex-1); }
        function nextPage() { if(state.currentChapterIndex<state.chapters.length-1) renderChapter(state.currentChapterIndex+1); }
        
        // AI çª—å£æ§åˆ¶
        function openAIChat() { toggleAICard(true); }
        function toggleAICard(show) { const c=document.getElementById('ai-card'); c.style.display = (show===true || c.style.display==='none') ? 'flex' : 'none'; }
         // 2. [ä¿®æ”¹] ç‚¹å‡»æ°”æ³¡èœå•çš„"é—®AI"
        function askAIWithSelection() {
            toggleAICard(true);
            
            // è§†è§‰åé¦ˆï¼šæŠŠé€‰ä¸­çš„å­—å¡«å…¥è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºä¸ºå¼•ç”¨æ ¼å¼ï¼Œæ–¹ä¾¿ç”¨æˆ·çŸ¥é“ AI ä¼šé’ˆå¯¹è¿™æ®µè¯
            const quote = `> ${state.selectedText}\n\n`;
            const input = document.getElementById('ai-input');
            input.value = quote; 
            input.focus();
            
            // éšè—æ°”æ³¡èœå•
            document.getElementById('bubble-menu').style.display = 'none';
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å¿«æ·æŒ‰é’®
            const msgBox = document.getElementById('ai-messages');
            msgBox.scrollTop = msgBox.scrollHeight;
        }
        function clearChat() { state.aiHistory = []; document.getElementById('ai-messages').innerHTML = '<div class="text-center text-xs opacity-40 py-4">å¯¹è¯å·²æ¸…ç©º</div>'; }
        
        // æ ·å¼è®¾ç½®
        function setTheme(t) { 
            document.body.setAttribute('data-theme', t); 
            localStorage.setItem('theme', t); 
            document.querySelectorAll('.color-btn').forEach(b => { 
                b.classList.toggle('active', b.getAttribute('onclick').includes(t)); 
            }); 
        }
        function changeFontSize(delta) { const newSize = state.fontSize + delta; if (newSize >= 14 && newSize <= 32) { state.fontSize = newSize; localStorage.setItem('fontSize', newSize); applyTypography(); } }
        function applyTypography() { const root = document.documentElement; root.style.setProperty('--font-size', state.fontSize + 'px'); document.getElementById('font-size-display').innerText = state.fontSize; }
        function toggleStylePanel() { const p = document.getElementById('style-panel'); p.style.display = p.style.display==='flex'?'none':'flex'; }
        
        // å¯¼å›¾èŠ‚ç‚¹æŠ˜å 
        function toggleMapNode(btn) { const li = btn.parentElement; const ul = li.querySelector('ul'); if(ul) { ul.classList.toggle('hidden'); li.classList.toggle('collapsed'); btn.innerText = ul.classList.contains('hidden') ? '+' : '-'; } }
        
        // ç« èŠ‚æ€»ç»“ç›¸å…³
        function openChapterSummary(idx, e) { 
            if(e) e.stopPropagation(); 
            state.editingChapterSummaryIndex = idx; 
            document.getElementById('summary-chap-title').innerText = state.chapters[idx].title; 
            document.getElementById('summary-input').value = state.chapterSummaries[idx] || ''; 
            document.getElementById('chapter-summary-modal').style.display = 'flex'; 
        }
        function saveChapterSummary() { 
            const txt = document.getElementById('summary-input').value; 
            const idx = state.editingChapterSummaryIndex;
            if(txt) { 
                state.chapterSummaries[idx] = txt; 
                logEvent('SUMMARY', `ç« èŠ‚æ€»ç»“: ${state.chapters[idx].title}`);
            } else { 
                delete state.chapterSummaries[idx]; 
            } 
            closeModal('chapter-summary-modal'); 
            renderTOC(); 
        }
        
        // ç›‘å¬é€‰åŒºå˜åŒ–ä»¥æ˜¾ç¤ºèœå•
        document.addEventListener('selectionchange', handleSelection);
        /* --- AI è®¾ç½®ç›¸å…³é€»è¾‘ --- */
        
        // 1. åˆ‡æ¢é¢æ¿æ˜¾ç¤º + æ¸²æŸ“æ ‡ç­¾
        function toggleAISettings() {
            const layer = document.getElementById('ai-settings-layer');
            
            if (layer.classList.contains('hidden')) {
                // æ‰“å¼€é¢æ¿
                layer.classList.remove('hidden');
                
                // å¡«å……å½“å‰æ­£åœ¨ä½¿ç”¨çš„æç¤ºè¯
                document.getElementById('ai-prompt-input').value = state.systemPrompt;
                
                // æ¸²æŸ“å¿«æ·æ ‡ç­¾ (æ¯æ¬¡æ‰“å¼€æ¸²æŸ“ä¸€æ¬¡ï¼Œç¡®ä¿æ•°æ®æœ€æ–°)
                const container = document.getElementById('preset-tags');
                container.innerHTML = state.aiPresets.map(p => 
                    `<button onclick="applyPreset('${p.prompt.replace(/'/g, "\\'")}')" 
                             class="text-xs px-2 py-1 bg-gray-100 hover:bg-[var(--accent-color)] hover:text-white rounded border border-gray-200 transition">
                        ${p.name}
                     </button>`
                ).join('');
                
            } else {
                // å…³é—­é¢æ¿
                layer.classList.add('hidden');
            }
        }
        
        // 2. ç‚¹å‡»æ ‡ç­¾ï¼šå°†é¢„è®¾å¡«å…¥è¾“å…¥æ¡† (å…è®¸ç”¨æˆ·äºŒæ¬¡ç¼–è¾‘)
        function applyPreset(text) {
            const input = document.getElementById('ai-prompt-input');
            input.value = text;
            // è§†è§‰åé¦ˆï¼šé—ªçƒä¸€ä¸‹è¾“å…¥æ¡†
            input.classList.add('bg-yellow-50');
            setTimeout(() => input.classList.remove('bg-yellow-50'), 200);
        }
        
        // 3. ä¿å­˜è®¾ç½® (ä¿æŒä¸å˜)
        function saveAIPrompt() {
            const val = document.getElementById('ai-prompt-input').value.trim();
            if (val) {
                state.systemPrompt = val;
                localStorage.setItem('systemPrompt', val); 
                
                // æŒ‰é’®åé¦ˆ
                const btn = document.querySelector('#ai-settings-layer button'); // è·å–ä¿å­˜æŒ‰é’®
                const oldText = btn.innerText;
                btn.innerText = "å·²ä¿å­˜ï¼";
                btn.classList.add('bg-green-600');
                
                setTimeout(() => {
                    btn.innerText = oldText;
                    btn.classList.remove('bg-green-600');
                    document.getElementById('ai-settings-layer').classList.add('hidden'); // å…³é—­
                }, 800);
            }
        }
        // 1. åˆå§‹åŒ–æ—¶æ¸²æŸ“å¿«æ·æŒ‰é’® (åŠ åœ¨ DOMContentLoaded é‡Œæˆ–è€…ç›´æ¥æ”¾åœ¨ script æœ«å°¾æ‰§è¡Œ)
        function renderQuickActions() {
            const container = document.getElementById('ai-quick-actions');
            if(!container) return;
            
            container.innerHTML = state.aiPresets.map(preset => `
                <button onclick="sendQuickAction('${preset.prompt}')" 
                        class="text-xs px-3 py-1.5 bg-white border border-gray-200 rounded-full text-gray-600 hover:text-[var(--accent-color)] hover:border-[var(--accent-color)] hover:bg-[var(--accent-color)]/5 transition shadow-sm flex-shrink-0">
                    ${preset.label}
                </button>
            `).join('');
        }
    </script>
</body>
</html>
